# .github/workflows/volume_bottom_scanner.yml
name: Volume Bottom Scanner 

on:
  
  schedule:
    - cron: '43 13 * * *'
  
  # 2. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # 3. è‡ªåŠ¨è§¦å‘ï¼šå½“è„šæœ¬æˆ–å·¥ä½œæµæ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    paths:
      - 'volume_bottom_scanner.py'
      - '.github/workflows/volume_bottom_scanner.yml'

jobs:
  run_scanner:
    runs-on: ubuntu-latest
    
    # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·ï¼Œç”¨äºåœ¨è„šæœ¬ä¸­ç”Ÿæˆæ­£ç¡®çš„æ—¶é—´æˆ³æ–‡ä»¶å
    env:
      TZ: Asia/Shanghai

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        # è·å–æ‰€æœ‰æäº¤å†å²ï¼Œä»¥ä¾¿äºåç»­ push
        with:
          fetch-depth: 0 

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' 

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pip install pandas

      - name: ğŸƒ è¿è¡Œè‚¡ç¥¨ç­›é€‰è„šæœ¬
        run: python volume_bottom_scanner.py
        # è„šæœ¬å°†ç”Ÿæˆ output/YYYY/MM/volume_bottom_scan_results_YYYYMMDD_HHMMSS.csv æ–‡ä»¶

      - name: ğŸ“‚ é…ç½® Git ç”¨æˆ·
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      - name: â¬†ï¸ æäº¤ç­›é€‰ç»“æœåˆ°ä»“åº“
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„ output æ–‡ä»¶ï¼Œå¦‚æœæœ‰åˆ™æäº¤
        run: |
          if [ -d "output" ]; then
            git add output/*.csv output/*/*.csv output/*/*/*.csv
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¢«æ·»åŠ 
            if git diff --cached --quiet; then
              echo "æ²¡æœ‰æ–°çš„ç­›é€‰ç»“æœæ–‡ä»¶ï¼Œè·³è¿‡æäº¤ã€‚"
            else
              # æäº¤å’Œæ¨é€
              git commit -m "ğŸ¤– Auto: Add volume bottom scan results for $(date +%Y-%m-%d)"
              git push
            fi
          else
            echo "æœªæ‰¾åˆ° output ç›®å½•ï¼Œè·³è¿‡æäº¤ã€‚"
          fi
